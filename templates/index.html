<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R27 Infinite AI Leads Agent</title>
    <!-- Cache buster: {{ cache_buster }} -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #06ffa5;
            --danger-color: #ff006e;
            --dark-bg: #0a0e27;
            --card-bg: #1a1f3a;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            background: white;
            margin-bottom: 2rem;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            padding: 1.5rem;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 40px;
            font-size: 1.1rem;
            border-radius: 50px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            color: white;
        }

        .progress {
            height: 30px;
            border-radius: 15px;
            background-color: #f0f0f0;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Apollo Tab Styling - Make it VISIBLE */
        #apollo-tab {
            background: linear-gradient(45deg, #00ff00, #32cd32) !important;
            color: #000 !important;
            font-weight: 900 !important;
            font-size: 1.2rem !important;
            border: 3px solid #00ff00 !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            padding: 12px 20px !important;
            animation: pulse 2s infinite !important;
        }

        #apollo-tab:hover {
            background: linear-gradient(45deg, #32cd32, #00ff00) !important;
            transform: scale(1.05) !important;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5) !important;
        }

        #apollo-tab.active {
            background: linear-gradient(45deg, #00ff00, #32cd32) !important;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.7) !important;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
            }
            100% {
                box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            }
        }

        /* Scheduler Tab Styling - Make it HIGHLY VISIBLE */
        #scheduler-tab {
            background: linear-gradient(45deg, #ff6b6b, #ff0066) !important;
            color: #fff !important;
            font-weight: 900 !important;
            font-size: 1.1rem !important;
            border: 3px solid #ff0066 !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
            padding: 12px 20px !important;
            animation: glow 2s ease-in-out infinite !important;
            margin-left: 10px !important;
        }

        #scheduler-tab:hover {
            background: linear-gradient(45deg, #ff0066, #ff6b6b) !important;
            transform: scale(1.1) !important;
            box-shadow: 0 0 30px rgba(255, 0, 102, 0.8) !important;
        }

        #scheduler-tab.active {
            background: linear-gradient(45deg, #ff0066, #ff3366) !important;
            box-shadow: 0 0 40px rgba(255, 0, 102, 1) !important;
        }

        @keyframes glow {
            0% {
                box-shadow: 0 0 15px rgba(255, 0, 102, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 0, 102, 0.9);
            }
            100% {
                box-shadow: 0 0 15px rgba(255, 0, 102, 0.5);
            }
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }

        .status-fetching, .status-normalizing, .status-generating_emails, .status-creating_csv, .status-uploading {
            background-color: #ffc107;
            color: #000;
        }

        .status-completed {
            background-color: #28a745;
            color: white;
        }

        .status-error {
            background-color: #dc3545;
            color: white;
        }

        .lead-preview {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .lead-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Score badge removed - no longer needed */

        .stats-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .stats-box h3 {
            margin: 0;
            font-size: 2rem;
        }

        .stats-box p {
            margin: 0;
            opacity: 0.9;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Enhanced Tab Styling */
        .nav-tabs {
            border-bottom: 3px solid rgba(255,255,255,0.2);
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            color: #fff;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(67, 97, 238, 0.3);
            padding: 1rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0 0.5rem 0 0;
            border-radius: 12px 12px 0 0;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .nav-tabs .nav-link.active {
            color: #fff;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: 2px solid var(--primary-color);
            box-shadow: 0 -4px 15px rgba(67, 97, 238, 0.5);
            transform: translateY(-3px);
        }

        .nav-tabs .nav-link:hover:not(.active) {
            color: #fff;
            background: rgba(67, 97, 238, 0.5);
            border: 2px solid rgba(255,255,255,0.5);
            transform: translateY(-2px);
            box-shadow: 0 -2px 10px rgba(67, 97, 238, 0.3);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="bi bi-graph-up-arrow"></i> R27 Infinite AI Leads Agent</h1>
            <p>Generate high-quality business leads with AI-powered scoring and personalized outreach</p>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="leadTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="google-tab" data-bs-toggle="tab" data-bs-target="#google" type="button">
                    üîç <i class="bi bi-geo-alt-fill"></i> <strong>SINGLE SEARCH</strong>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="apollo-tab" data-bs-toggle="tab" data-bs-target="#apollo" type="button">
                    üöÄ <i class="bi bi-file-earmark-arrow-up-fill"></i> <strong>APOLLO CSV</strong>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scheduler-tab" data-bs-toggle="tab" data-bs-target="#scheduler" type="button">
                    ‚è∞ <i class="bi bi-calendar-check-fill"></i> <strong>SCHEDULER</strong>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="enhanced-tab" data-bs-toggle="tab" data-bs-target="#enhanced" type="button">
                    ‚ö° <i class="bi bi-stars"></i> <strong>ENHANCED</strong>
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="leadTabContent">
            <!-- Google Maps Tab -->
            <div class="tab-pane fade show active" id="google" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-search"></i> Google Maps Lead Generation
                    </div>
                    <div class="card-body p-4">
                        <form id="leadForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="query" class="form-label fw-bold">Search Query</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" id="query" 
                                       placeholder="e.g., lawyers in Las Vegas" required>
                                <button type="button" class="btn btn-outline-secondary" id="expandKeywords">
                                    <i class="bi bi-magic"></i> Expand
                                </button>
                            </div>
                            <small class="text-muted">Enter business type and location, then click Expand to generate related search terms</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="limit" class="form-label fw-bold">Number of Leads</label>
                            <select class="form-select form-select-lg" id="limit">
                                <option value="5">5 leads (Demo)</option>
                                <option value="10">10 leads</option>
                                <option value="25" selected>25 leads</option>
                                <option value="50">50 leads</option>
                                <option value="100">100 leads</option>
                                <option value="250">250 leads</option>
                                <option value="500">500 leads</option>
                                <option value="1000">1000 leads (Max)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Keyword Expansion Section -->
                    <div id="keywordExpansionSection" class="row mb-4" style="display: none;">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-magic"></i> Expanded Search Terms</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">Select the search terms you want to include (all are selected by default):</p>
                                    <div id="keywordList" class="row">
                                        <!-- Keywords will be populated here -->
                                    </div>
                                    <div class="text-end mt-3">
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleAllKeywords(false)">
                                            Deselect All
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="toggleAllKeywords(true)">
                                            Select All
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="hideKeywordExpansion()">
                                            Use Selected Terms
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="verifyEmails" checked>
                                <label class="form-check-label" for="verifyEmails">
                                    <strong>Verify Emails</strong> - Check email validity and deliverability (adds ~1 second per lead)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateEmails">
                                <label class="form-check-label" for="generateEmails">
                                    <strong>Generate Emails</strong> - Create personalized outreach emails (adds ~2 seconds per lead)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportVerifiedOnly" checked>
                                <label class="form-check-label" for="exportVerifiedOnly">
                                    <strong>Export Only Verified Emails</strong> - Filter out leads with invalid or unverified emails from download
                                </label>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="advancedScraping">
                                <label class="form-check-label" for="advancedScraping">
                                    <strong>Advanced Website Scraping</strong> - Extract contact person names, job titles, and other details from team/about pages (adds ~3 seconds per lead)
                                    <br><small class="text-muted">Finds: First names, Contact person, Job titles, Team member names</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-generate" id="generateBtn">
                            <i class="bi bi-magic"></i> Generate Leads
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearCacheAndRefresh()">
                            <i class="bi bi-arrow-clockwise"></i> Clear Cache & Refresh
                        </button>
                    </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Apollo CSV Tab -->
            <div class="tab-pane fade" id="apollo" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Apollo CSV Personalization
                    </div>
                    <div class="card-body p-4">
                        <form id="apolloForm">
                            <div class="mb-4">
                                <label for="apolloFile" class="form-label fw-bold">Upload Apollo CSV</label>
                                <input type="file" class="form-control form-control-lg" id="apolloFile" accept=".csv" required>
                                <small class="text-muted">Upload your Apollo export with columns: first_name, title, email, organization_name, etc.</small>
                            </div>
                            <div class="mb-3">
                                <label for="serviceFocus" class="form-label fw-bold">Service Focus</label>
                                <input type="text" class="form-control form-control-lg" id="serviceFocus" 
                                       placeholder="e.g., 'lead generation and database reactivation' or 'AI chatbots for customer service'"
                                       value="general AI automation">
                                <small class="text-muted">Describe what services you want to focus on - GPT will adapt the messaging</small>
                            </div>
                            <div class="mb-3">
                                <label for="maxLeads" class="form-label fw-bold">Max Leads to Process</label>
                                <input type="number" class="form-control form-control-lg" id="maxLeads" value="100" min="1" max="1000">
                                <small class="text-muted">Processing time: ~2-3 seconds per lead</small>
                            </div>
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-generate" id="apolloBtn">
                                    <i class="bi bi-envelope"></i> Generate Personalized Emails
                                </button>
                            </div>
                        </form>
                        
                        <!-- Apollo Progress Section -->
                        <div class="d-none mt-4" id="apolloProgressSection">
                            <hr>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <span class="spinner-border spinner-border-sm text-primary" id="apolloSpinner"></span>
                                    <span id="apolloStatusMessage">Processing...</span>
                                </h5>
                                <button class="btn btn-danger" id="apolloCancelBtn">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="apolloProgressBar" style="width: 0%">0%</div>
                            </div>
                            <div class="mt-3 text-center d-none" id="apolloDownloadSection">
                                <a href="#" class="btn btn-success btn-lg" id="apolloDownloadBtn">
                                    <i class="bi bi-download"></i> Download CSV
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduler Tab -->
            <div class="tab-pane fade" id="scheduler" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-clock-history"></i> Scheduled Searches & Queue</span>
                        <button class="btn btn-sm btn-primary" onclick="showAddScheduleModal()">
                            <i class="bi bi-plus-circle"></i> Add Schedule
                        </button>
                    </div>
                    <div class="card-body p-4">
                        <!-- CSV Bulk Upload Section -->
                        <div class="mb-4 p-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px;">
                            <h5 class="fw-bold text-white mb-3">
                                <i class="bi bi-file-earmark-spreadsheet"></i> üìä BULK CSV UPLOAD - Add 100s of Searches at Once! üìä
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="bg-white p-3 rounded">
                                        <label class="form-label fw-bold">Upload CSV with Multiple Searches</label>
                                        <input type="file" class="form-control mb-2" id="bulkScheduleFile" accept=".csv">
                                        <button class="btn btn-success w-100" onclick="uploadBulkSchedules()">
                                            <i class="bi bi-cloud-upload"></i> Upload & Schedule All
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-white p-3 rounded">
                                        <label class="form-label fw-bold">Need a Template?</label>
                                        <p class="text-muted small">Download our CSV template with examples</p>
                                        <a href="/api/schedules/template" class="btn btn-primary w-100" download>
                                            <i class="bi bi-download"></i> Download CSV Template
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 text-white">
                                <small>
                                    <strong>How it works:</strong><br>
                                    ‚Ä¢ Searches are automatically scheduled with time gaps to avoid overloading<br>
                                    ‚Ä¢ Default: 15 minutes between searches (customizable with interval_minutes column)<br>
                                    ‚Ä¢ Use "max" in limit_leads column to get maximum leads (1000)<br>
                                    ‚Ä¢ Each search runs at its scheduled time and is marked complete when done<br>
                                    ‚Ä¢ Example: Upload 50 states ‚Üí Scheduled over ~12 hours (50 √ó 15 min)
                                </small>
                            </div>
                            <div id="bulkUploadResults" class="mt-3 d-none">
                                <div class="alert alert-info" id="bulkUploadMessage"></div>
                            </div>
                        </div>

                        <!-- Quick Add to Queue with All Options -->
                        <div class="mb-4 p-4 border rounded bg-light">
                            <h5 class="fw-bold mb-3"><i class="bi bi-plus-square"></i> Add Search to Queue</h5>
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Search Query</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg" id="quickQuery" 
                                               placeholder="e.g., lawyers in Las Vegas">
                                        <button type="button" class="btn btn-outline-secondary" onclick="expandQueueKeywords()">
                                            <i class="bi bi-magic"></i> Expand
                                        </button>
                                    </div>
                                    <small class="text-muted">Enter business type and location</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Number of Leads</label>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range flex-grow-1" id="quickLimitSlider" 
                                               min="5" max="500" value="25" oninput="updateQueueLimit(this.value)">
                                        <input type="number" class="form-control ms-2" id="quickLimit" 
                                               value="25" min="5" max="1000" style="width: 80px"
                                               onchange="document.getElementById('quickLimitSlider').value = Math.min(this.value, 500)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Keyword Expansion Results -->
                            <div id="queueKeywordResults" class="mt-3 d-none"></div>
                            
                            <!-- Options Checkboxes -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="queueVerifyEmails" checked>
                                        <label class="form-check-label" for="queueVerifyEmails">
                                            <strong>Verify Emails</strong> - Check validity
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="queueGenerateEmails">
                                        <label class="form-check-label" for="queueGenerateEmails">
                                            <strong>Generate Emails</strong> - Create outreach
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="queueExportVerified" checked>
                                        <label class="form-check-label" for="queueExportVerified">
                                            <strong>Export Verified Only</strong> - Filter invalid
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="queueAdvancedScraping">
                                        <label class="form-check-label" for="queueAdvancedScraping">
                                            <strong>Advanced Scraping</strong> - Extract names
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Priority Selection -->
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Priority</label>
                                    <select class="form-select" id="queuePriority">
                                        <option value="1">High (Process First)</option>
                                        <option value="5" selected>Normal</option>
                                        <option value="10">Low (Process Last)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Schedule For</label>
                                    <select class="form-select" id="queueScheduleType">
                                        <option value="now">Process Now</option>
                                        <option value="later">Schedule for Later</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success btn-lg w-100 mt-4" onclick="addToQueueWithOptions()">
                                        <i class="bi bi-plus-circle"></i> Add to Queue
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Schedules List -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Active Schedules</h6>
                            <div id="schedulesList" class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Query</th>
                                            <th>Leads</th>
                                            <th>Interval</th>
                                            <th>Next Run</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedulesTableBody">
                                        <tr><td colspan="6" class="text-center text-muted">Loading schedules...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Queue Status -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Queue Status</h6>
                            <div id="queueList" class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Query</th>
                                            <th>Leads</th>
                                            <th>Status</th>
                                            <th>Scheduled For</th>
                                        </tr>
                                    </thead>
                                    <tbody id="queueTableBody">
                                        <tr><td colspan="5" class="text-center text-muted">Loading queue...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Search History -->
                        <div>
                            <h6 class="fw-bold">Recent History</h6>
                            <div id="historyList" class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Query</th>
                                            <th>Leads</th>
                                            <th>Emails</th>
                                            <th>Status</th>
                                            <th>Completed</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody">
                                        <tr><td colspan="5" class="text-center text-muted">Loading history...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="card d-none" id="progressSection">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <span class="spinner-border text-primary d-none" id="spinner"></span>
                        <span id="statusMessage">Initializing...</span>
                    </h5>
                    <span class="status-badge" id="statusBadge">Starting</span>
                </div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progressBar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card d-none" id="resultsSection">
            <div class="card-header">
                <i class="bi bi-check-circle"></i> Results
            </div>
            <div class="card-body p-4">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-box">
                            <h3 id="totalLeads">0</h3>
                            <p>Total Leads</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box">
                            <h3 id="emailsVerified">0</h3>
                            <p>Emails Found</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-box">
                            <h3><i class="bi bi-download"></i></h3>
                            <p>Download Ready</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <button class="btn btn-success btn-lg me-2" id="downloadBtn">
                        <i class="bi bi-download"></i> Download CSV
                    </button>
                    <button class="btn btn-primary btn-lg d-none" id="driveBtn">
                        <i class="bi bi-cloud"></i> Open in Drive
                    </button>
                </div>

                <h5 class="mb-3"><i class="bi bi-eye"></i> Lead Preview (First 5)</h5>
                <div id="leadPreview" class="lead-preview">
                    <!-- Leads will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Enhanced Features Tab -->
        <div class="tab-pane fade" id="enhanced" role="tabpanel">
            <div class="row">
                <!-- Multi-Provider Search -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="bi bi-collection"></i> Multi-Provider Search
                            <span class="badge bg-primary ms-2" data-bs-toggle="tooltip" title="Search across Google Maps, Yelp, and Yellow Pages simultaneously for maximum coverage">NEW</span>
                        </div>
                        <div class="card-body">
                            <form id="multiProviderForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Search Query</label>
                                    <input type="text" class="form-control" id="multiQuery" placeholder="e.g., restaurants in Miami" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Data Sources</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="providerGoogle" value="google_maps" checked>
                                        <label class="form-check-label" for="providerGoogle">
                                            <i class="bi bi-geo-alt-fill text-danger"></i> Google Maps
                                            <span class="badge bg-success ms-1" data-bs-toggle="tooltip" title="Primary business directory with comprehensive coverage">MAIN</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="providerOSM" value="openstreetmap">
                                        <label class="form-check-label" for="providerOSM">
                                            <i class="bi bi-globe text-success"></i> OpenStreetMap
                                            <span class="badge bg-success ms-1" data-bs-toggle="tooltip" title="Free open-source business directory with global coverage">FREE</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="providerYP" value="yellowpages">
                                        <label class="form-check-label" for="providerYP">
                                            <i class="bi bi-telephone-fill text-warning"></i> Yellow Pages
                                            <span class="badge bg-warning text-dark ms-1" data-bs-toggle="tooltip" title="US business directory with phone numbers and addresses">FREE</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Limit per Source</label>
                                        <select class="form-select" id="multiLimit">
                                            <option value="10">10 leads</option>
                                            <option value="25" selected>25 leads</option>
                                            <option value="50">50 leads</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Location</label>
                                        <input type="text" class="form-control" id="multiLocation" placeholder="Optional location filter">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-gradient w-100">
                                    <i class="bi bi-search"></i> Search All Sources
                                </button>
                            </form>
                            <div id="multiProviderResults" class="mt-3 d-none">
                                <h6 class="fw-bold">Results Summary</h6>
                                <div id="multiProviderSummary" class="mb-3"></div>
                                <div id="multiProviderData"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lead Enrichment -->
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <i class="bi bi-magic"></i> Lead Enrichment
                            <span class="badge bg-success ms-2" data-bs-toggle="tooltip" title="Enhance your leads with social media profiles, company size, and technology stack information">AI POWERED</span>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Upload a CSV of leads to enrich with additional data:</p>
                            <ul class="list-unstyled mb-3">
                                <li><i class="bi bi-check-circle text-success"></i> Social Media Discovery</li>
                                <li><i class="bi bi-check-circle text-success"></i> Company Size Detection</li>
                                <li><i class="bi bi-check-circle text-success"></i> Technology Stack Analysis</li>
                                <li><i class="bi bi-check-circle text-success"></i> Business Type Classification</li>
                                <li><i class="bi bi-check-circle text-success"></i> Phone Number Validation</li>
                            </ul>
                            <form id="enrichmentForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Upload CSV File</label>
                                    <input type="file" class="form-control" id="enrichmentFile" accept=".csv" required>
                                    <small class="text-muted">CSV should contain Name, Email, Website, and/or Phone columns</small>
                                </div>
                                <button type="submit" class="btn btn-gradient w-100">
                                    <i class="bi bi-stars"></i> Enrich Leads
                                </button>
                            </form>
                            <div id="enrichmentResults" class="mt-3 d-none">
                                <div id="enrichmentSummary" class="alert alert-info"></div>
                                <button class="btn btn-success" id="downloadEnrichedBtn">
                                    <i class="bi bi-download"></i> Download Enriched CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instantly Campaign Management -->
                <div class="col-md-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-envelope-heart"></i> Instantly Campaign Management
                            <span class="badge bg-warning text-dark ms-2" data-bs-toggle="tooltip" title="Create and manage email campaigns directly from your lead data">CAMPAIGNS</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold">Create New Campaign</h6>
                                    <form id="instantlyForm">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Campaign Name</label>
                                            <input type="text" class="form-control" id="campaignName" placeholder="e.g., Restaurant Outreach Q1 2024" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Template Type</label>
                                            <select class="form-select" id="templateType" required>
                                                <option value="">Select template...</option>
                                                <option value="real_estate">Real Estate Outreach</option>
                                                <option value="lawyer">Legal Services</option>
                                                <option value="restaurant">Restaurant/Hospitality</option>
                                                <option value="generic">Generic B2B</option>
                                            </select>
                                            <small class="text-muted">Pre-built email sequences optimized for different industries</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Upload Leads CSV</label>
                                            <input type="file" class="form-control" id="campaignLeadsFile" accept=".csv" required>
                                            <small class="text-muted">CSV from your lead generation results</small>
                                        </div>
                                        <button type="submit" class="btn btn-gradient">
                                            <i class="bi bi-rocket"></i> Create Campaign
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold">Existing Campaigns</h6>
                                    <div id="campaignsList">
                                        <button class="btn btn-outline-primary w-100" onclick="loadInstantlyCampaigns()">
                                            <i class="bi bi-arrow-clockwise"></i> Load Campaigns
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="instantlyResults" class="mt-3 d-none">
                                <div class="alert alert-success" id="instantlyMessage"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Provider Status Dashboard -->
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-speedometer2"></i> Provider Status Dashboard
                        </div>
                        <div class="card-body">
                            <div class="row" id="providerStatus">
                                <div class="col-md-12 text-center">
                                    <button class="btn btn-outline-primary" onclick="checkProviderStatus()">
                                        <i class="bi bi-arrow-clockwise"></i> Check All Providers
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Section -->
        <div class="alert alert-danger d-none" id="errorSection">
            <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentJobId = null;
        let pollInterval = null;
        
        // Function to clear cache and refresh page
        function clearCacheAndRefresh() {
            // Clear various cache types
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    names.forEach(function(name) {
                        caches.delete(name);
                    });
                });
            }
            
            // Clear localStorage and sessionStorage
            if (typeof(Storage) !== "undefined") {
                localStorage.clear();
                sessionStorage.clear();
            }
            
            // Force reload with cache bypass
            window.location.reload(true);
        }
        
        // Global variables for keyword expansion
        let expandedKeywords = [];
        let selectedKeywords = new Set();
        
        // Keyword expansion functions
        async function expandKeywords() {
            const queryInput = document.getElementById('query');
            const query = queryInput.value.trim();
            
            if (!query) {
                alert('Please enter a search query first');
                return;
            }
            
            const expandBtn = document.getElementById('expandKeywords');
            const originalText = expandBtn.innerHTML;
            expandBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Expanding...';
            expandBtn.disabled = true;
            
            try {
                // Parse query to extract keyword and location
                const parts = query.toLowerCase().includes(' in ') ? query.split(' in ') : [query, ''];
                const keyword = parts[0].trim();
                const location = parts[1] ? parts[1].trim() : '';
                
                const response = await fetch('/api/expand-keywords', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword, location})
                });
                
                if (!response.ok) throw new Error('Failed to expand keywords');
                
                const data = await response.json();
                expandedKeywords = data.variants;
                
                // Show the expansion section
                displayExpandedKeywords(data.variants);
                document.getElementById('keywordExpansionSection').style.display = 'block';
                
                // Scroll to the expansion section
                document.getElementById('keywordExpansionSection').scrollIntoView({behavior: 'smooth'});
                
            } catch (error) {
                console.error('Keyword expansion error:', error);
                alert('Failed to expand keywords. Please try again.');
            } finally {
                expandBtn.innerHTML = originalText;
                expandBtn.disabled = false;
            }
        }
        
        function displayExpandedKeywords(variants) {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = '';
            selectedKeywords.clear();
            
            variants.forEach((variant, index) => {
                const keywordId = `keyword_${index}`;
                selectedKeywords.add(variant.keyword); // All selected by default
                
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-2';
                
                col.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input keyword-checkbox" type="checkbox" 
                               id="${keywordId}" value="${variant.keyword}" checked>
                        <label class="form-check-label" for="${keywordId}" title="${variant.description}">
                            <strong>${variant.keyword}</strong>
                            <br><small class="text-muted">${variant.description}</small>
                        </label>
                    </div>
                `;
                
                keywordList.appendChild(col);
            });
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.keyword-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedKeywords.add(this.value);
                    } else {
                        selectedKeywords.delete(this.value);
                    }
                });
            });
        }
        
        function toggleAllKeywords(select) {
            const checkboxes = document.querySelectorAll('.keyword-checkbox');
            selectedKeywords.clear();
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = select;
                if (select) {
                    selectedKeywords.add(checkbox.value);
                }
            });
        }
        
        function hideKeywordExpansion() {
            document.getElementById('keywordExpansionSection').style.display = 'none';
            
            if (selectedKeywords.size > 0) {
                // Update the main query with selected keywords (just show count)
                const queryInput = document.getElementById('query');
                const originalQuery = queryInput.value;
                queryInput.value = `${selectedKeywords.size} search terms selected (${Array.from(selectedKeywords).slice(0, 2).join(', ')}${selectedKeywords.size > 2 ? '...' : ''})`;
                queryInput.title = Array.from(selectedKeywords).join(', ');
            }
        }
        
        // Add event listener for expand button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('expandKeywords').addEventListener('click', expandKeywords);
        });

        document.getElementById('leadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Form submitted!');
            
            // Handle multiple keywords if expanded
            let searchQueries = [];
            if (selectedKeywords.size > 0) {
                searchQueries = Array.from(selectedKeywords);
            } else {
                searchQueries = [document.getElementById('query').value];
            }
            
            const limit = document.getElementById('limit').value;
            const verifyEmails = document.getElementById('verifyEmails').checked;
            const generateEmails = document.getElementById('generateEmails').checked;
            const exportVerifiedOnly = document.getElementById('exportVerifiedOnly').checked;
            const advancedScraping = document.getElementById('advancedScraping').checked;
            
            console.log('Form values:', {searchQueries, limit, verifyEmails, generateEmails, exportVerifiedOnly, advancedScraping});
            
            // Reset UI
            document.getElementById('errorSection').classList.add('d-none');
            document.getElementById('resultsSection').classList.add('d-none');
            document.getElementById('progressSection').classList.remove('d-none');
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('spinner').classList.remove('d-none');
            
            try {
                console.log('Making API request...');
                // Start job
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: searchQueries.length === 1 ? searchQueries[0] : searchQueries.join(' | '),
                        queries: searchQueries, // Send all queries
                        limit: parseInt(limit), 
                        verify_emails: verifyEmails, 
                        generate_emails: generateEmails, 
                        export_verified_only: exportVerifiedOnly, 
                        advanced_scraping: advancedScraping
                    })
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) throw new Error('Failed to start job');
                
                const data = await response.json();
                currentJobId = data.job_id;
                
                // Start polling for status
                pollStatus();
                pollInterval = setInterval(pollStatus, 1000);
                
            } catch (error) {
                showError(error.message);
            }
        });

        // Apollo Form Handler
        // Apollo form handling
        let apolloJobId = null;
        let apolloPollInterval = null;
        
        document.getElementById('apolloForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('apolloFile');
            const serviceFocus = document.getElementById('serviceFocus').value;
            const maxLeads = document.getElementById('maxLeads').value;
            
            if (!fileInput.files[0]) {
                showError('Please select a CSV file');
                return;
            }
            
            // Show progress section
            document.getElementById('apolloProgressSection').classList.remove('d-none');
            document.getElementById('apolloDownloadSection').classList.add('d-none');
            document.getElementById('apolloBtn').disabled = true;
            document.getElementById('apolloStatusMessage').textContent = 'Uploading file...';
            document.getElementById('apolloProgressBar').style.width = '0%';
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('service_focus', serviceFocus);
                formData.append('max_leads', maxLeads);
                
                const response = await fetch('/api/process-apollo', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to process file');
                }
                
                const data = await response.json();
                apolloJobId = data.job_id;
                
                // Start polling for status
                apolloPollInterval = setInterval(pollApolloStatus, 1000);
                
            } catch (error) {
                showError(error.message);
                document.getElementById('apolloProgressSection').classList.add('d-none');
                document.getElementById('apolloBtn').disabled = false;
            }
        });
        
        // Cancel button
        document.getElementById('apolloCancelBtn').addEventListener('click', async () => {
            if (!apolloJobId) return;
            
            try {
                await fetch(`/api/apollo-cancel/${apolloJobId}`, { method: 'POST' });
                clearInterval(apolloPollInterval);
                document.getElementById('apolloProgressSection').classList.add('d-none');
                document.getElementById('apolloBtn').disabled = false;
                showError('Processing cancelled');
            } catch (error) {
                console.error('Cancel error:', error);
            }
        });
        
        async function pollApolloStatus() {
            if (!apolloJobId) return;
            
            try {
                const response = await fetch(`/api/apollo-status/${apolloJobId}`);
                if (!response.ok) throw new Error('Failed to get status');
                
                const data = await response.json();
                
                // Update progress
                document.getElementById('apolloProgressBar').style.width = `${data.progress}%`;
                document.getElementById('apolloProgressBar').textContent = `${data.progress}%`;
                document.getElementById('apolloStatusMessage').textContent = data.message;
                
                if (data.status === 'completed') {
                    clearInterval(apolloPollInterval);
                    document.getElementById('apolloSpinner').classList.add('d-none');
                    document.getElementById('apolloCancelBtn').classList.add('d-none');
                    document.getElementById('apolloDownloadSection').classList.remove('d-none');
                    document.getElementById('apolloDownloadBtn').href = `/api/download-apollo/${data.result_file}`;
                    document.getElementById('apolloBtn').disabled = false;
                } else if (data.status === 'error' || data.status === 'cancelled') {
                    clearInterval(apolloPollInterval);
                    showError(data.error || data.message);
                    document.getElementById('apolloProgressSection').classList.add('d-none');
                    document.getElementById('apolloBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Poll error:', error);
                clearInterval(pollInterval);
                showError('Connection error: ' + error.message);
            }
        }

        async function pollStatus() {
            if (!currentJobId) return;
            
            try {
                console.log(`Polling status for job: ${currentJobId}`);
                const response = await fetch(`/api/status/${currentJobId}`);
                if (!response.ok) throw new Error('Failed to get status');
                
                const data = await response.json();
                console.log('Poll response:', data);
                updateProgress(data);
                
                if (data.status === 'completed') {
                    console.log('Job completed, showing results...');
                    clearInterval(pollInterval);
                    showResults(data);
                } else if (data.status === 'error') {
                    console.log('Job error:', data.error);
                    clearInterval(pollInterval);
                    showError(data.error || 'Job failed');
                }
                
            } catch (error) {
                console.error('Poll error:', error);
                clearInterval(pollInterval);
                showError('Connection error: ' + error.message);
            }
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const statusMessage = document.getElementById('statusMessage');
            const statusBadge = document.getElementById('statusBadge');
            
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${data.progress}%`;
            statusMessage.textContent = data.message;
            
            // Update status badge
            statusBadge.className = `status-badge status-${data.status}`;
            statusBadge.textContent = data.status.replace('_', ' ').toUpperCase();
        }

        function showResults(data) {
            console.log('showResults called with:', data);
            document.getElementById('progressSection').classList.add('d-none');
            document.getElementById('resultsSection').classList.remove('d-none');
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('spinner').classList.add('d-none');
            
            // Update stats
            document.getElementById('totalLeads').textContent = data.total_leads;
            document.getElementById('emailsVerified').textContent = data.emails_verified || 0;
            
            // Show message if verified-only filter was applied
            if (data.message && data.message.includes('verified emails')) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert alert-info mt-3';
                messageDiv.innerHTML = `<i class="bi bi-info-circle"></i> ${data.message}`;
                document.querySelector('#resultsSection .card-body').insertBefore(messageDiv, document.querySelector('.row'));
            }
            
            // Add email verification summary if available
            if (data.emails_verified !== undefined && data.emails_verified > 0) {
                const resultsCard = document.querySelector('#resultsSection .card-body');
                if (resultsCard && !resultsCard.querySelector('.email-stats')) {
                    const emailDiv = document.createElement('div');
                    emailDiv.className = 'email-stats mt-2 pt-2 border-top';
                    emailDiv.innerHTML = `
                        <small class="text-muted">Email Verification:</small><br>
                        <span class="badge bg-info">${data.emails_verified} Emails Found</span>
                        <span class="badge bg-success ms-1">${data.valid_emails || 0} Valid</span>
                    `;
                    // Insert after the stats boxes
                    const statsRow = resultsCard.querySelector('.row');
                    if (statsRow) {
                        statsRow.parentNode.insertBefore(emailDiv, statsRow.nextSibling);
                    }
                }
            }
            
            
            // Set up download button with better error handling
            console.log('Setting up download button for job:', currentJobId);
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.onclick = () => {
                    console.log('Download button clicked, downloading:', currentJobId);
                    try {
                        window.location.href = `/api/download/${currentJobId}`;
                    } catch (error) {
                        console.error('Download error:', error);
                        alert('Download failed: ' + error.message);
                    }
                };
            } else {
                console.error('Download button not found!');
            }
            
            // Set up Drive button if available
            if (data.share_link) {
                const driveBtn = document.getElementById('driveBtn');
                driveBtn.classList.remove('d-none');
                driveBtn.onclick = () => {
                    window.open(data.share_link, '_blank');
                };
            }
            
            // Show lead preview with proper email verification status
            const preview = document.getElementById('leadPreview');
            preview.innerHTML = '';
            
            if (data.leads_preview && data.leads_preview.length > 0) {
                // Add a header showing how many leads are displayed
                const headerDiv = document.createElement('div');
                headerDiv.className = 'mb-3 text-muted';
                headerDiv.innerHTML = `<small>Showing ${data.leads_preview.length} of ${data.total_leads} leads</small>`;
                preview.appendChild(headerDiv);
                
                data.leads_preview.forEach((lead, index) => {
                    // Determine email status display
                    let emailStatus = '';
                    let emailBadgeClass = '';
                    let emailIcon = '';
                    
                    // Debug logging
                    console.log(`Lead ${index + 1}:`, lead.Name);
                    console.log('  Email:', lead.Email);
                    console.log('  email_verified:', lead.email_verified);
                    console.log('  email_status:', lead.email_status);
                    
                    if (!lead.Email || lead.Email === 'NA' || lead.Email === '') {
                        emailStatus = 'No Email';
                        emailBadgeClass = 'bg-secondary';
                        emailIcon = 'üìß‚ùå';
                    } else {
                        // Email exists, check verification status
                        if (lead.email_verified === true || lead.email_verified === 'True' || lead.email_verified === 'true') {
                            emailStatus = 'Valid Email';
                            emailBadgeClass = 'bg-success';
                            emailIcon = '‚úÖ';
                        } else if (lead.email_status === 'catch-all' || lead.email_status === 'catch_all') {
                            emailStatus = 'Catch-All';
                            emailBadgeClass = 'bg-warning text-dark';
                            emailIcon = '‚ö†Ô∏è';
                        } else if (lead.email_status === 'invalid') {
                            emailStatus = 'Invalid Email';
                            emailBadgeClass = 'bg-danger';
                            emailIcon = '‚ùå';
                        } else if (lead.email_status === 'error') {
                            emailStatus = 'Verification Error';
                            emailBadgeClass = 'bg-warning text-dark';
                            emailIcon = '‚ö†Ô∏è';
                        } else if (lead.email_status === 'missing') {
                            emailStatus = 'No Email';
                            emailBadgeClass = 'bg-secondary';
                            emailIcon = 'üìß‚ùå';
                        } else {
                            emailStatus = 'Unverified';
                            emailBadgeClass = 'bg-info';
                            emailIcon = '‚ùì';
                        }
                    }
                    
                    const leadDiv = document.createElement('div');
                    leadDiv.className = 'lead-item fade-in';
                    leadDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <h6 class="fw-bold">${index + 1}. ${lead.Name}</h6>
                                <p class="text-muted mb-1"><i class="bi bi-geo-alt"></i> ${lead.Address}</p>
                                <div class="mb-1">
                                    <span class="badge ${emailBadgeClass} me-2">${emailIcon} ${emailStatus}</span>
                                    ${lead.Email && lead.Email !== 'NA' ? `<small class="text-muted">${lead.Email}</small>` : ''}
                                </div>
                                ${lead.Phone && lead.Phone !== 'NA' ? `<p class="mb-0"><small><i class="bi bi-telephone"></i> ${lead.Phone}</small></p>` : ''}
                                ${lead.Website && lead.Website !== 'NA' ? `<p class="mb-0"><small><i class="bi bi-globe"></i> <a href="${lead.Website}" target="_blank">Website</a></small></p>` : ''}
                            </div>
                            <div class="text-end">
                                ${lead.email_quality_boost ? `<small class="text-muted">Email Boost: ${lead.email_quality_boost > 0 ? '+' : ''}${lead.email_quality_boost}</small>` : ''}
                            </div>
                        </div>
                    `;
                    preview.appendChild(leadDiv);
                });
            }
        }

        function showError(message) {
            document.getElementById('progressSection').classList.add('d-none');
            document.getElementById('errorSection').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('spinner').classList.add('d-none');
            clearInterval(pollInterval);
        }

        // Check system health on load
        async function checkHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                console.log('System health:', data);
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        checkHealth();

        // Scheduler functions
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const schedules = await response.json();
                
                const tbody = document.getElementById('schedulesTableBody');
                if (schedules.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No scheduled searches</td></tr>';
                } else {
                    tbody.innerHTML = schedules.map(schedule => `
                        <tr>
                            <td>${schedule.name}</td>
                            <td>${schedule.query}</td>
                            <td>${schedule.limit_leads}</td>
                            <td>${schedule.interval_hours}h</td>
                            <td>${new Date(schedule.next_run).toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-${schedule.enabled ? 'warning' : 'success'}" 
                                        onclick="toggleSchedule(${schedule.id}, ${!schedule.enabled})">
                                    ${schedule.enabled ? 'Disable' : 'Enable'}
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSchedule(${schedule.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        async function loadQueue() {
            try {
                const response = await fetch('/api/queue');
                const queue = await response.json();
                
                const tbody = document.getElementById('queueTableBody');
                if (queue.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Queue is empty</td></tr>';
                } else {
                    tbody.innerHTML = queue.map((item, index) => {
                        // Format scheduled time in local timezone
                        let scheduledTime = '';
                        if (item.scheduled_time) {
                            const date = new Date(item.scheduled_time);
                            scheduledTime = date.toLocaleString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit',
                                hour12: true
                            });
                        } else {
                            scheduledTime = 'Immediate';
                        }
                        
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.query}</td>
                                <td>${item.limit_leads}</td>
                                <td><span class="badge bg-${getStatusColor(item.status)}">${item.status}</span></td>
                                <td>${scheduledTime}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading queue:', error);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history?limit=10');
                const history = await response.json();
                
                const tbody = document.getElementById('historyTableBody');
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No history</td></tr>';
                } else {
                    tbody.innerHTML = history.map(item => `
                        <tr>
                            <td>${item.query}</td>
                            <td>${item.leads_found}</td>
                            <td>${item.emails_found}/${item.emails_valid}</td>
                            <td><span class="badge bg-${getStatusColor(item.status)}">${item.status}</span></td>
                            <td>${new Date(item.completed_at).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'completed': return 'success';
                case 'processing': return 'warning';
                case 'error': return 'danger';
                case 'pending': return 'info';
                default: return 'secondary';
            }
        }

        async function uploadBulkSchedules() {
            const fileInput = document.getElementById('bulkScheduleFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to upload');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/schedules/bulk-upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const resultsDiv = document.getElementById('bulkUploadResults');
                    const messageDiv = document.getElementById('bulkUploadMessage');
                    
                    resultsDiv.classList.remove('d-none');
                    messageDiv.innerHTML = `
                        <strong>Upload Complete!</strong><br>
                        ‚úÖ Successfully added: ${result.total_added} schedules/queue items<br>
                        ${result.total_errors > 0 ? `‚ö†Ô∏è Errors: ${result.total_errors} rows failed<br>` : ''}
                        Total processed: ${result.total_processed} rows
                    `;
                    
                    // Clear the file input
                    fileInput.value = '';
                    
                    // Reload schedules and queue
                    loadSchedules();
                    loadQueue();
                } else {
                    alert(`Upload failed: ${result.error}`);
                }
            } catch (error) {
                console.error('Error uploading bulk schedules:', error);
                alert('Failed to upload CSV file');
            }
        }

        // Update queue limit display
        function updateQueueLimit(value) {
            document.getElementById('quickLimit').value = value;
        }

        // Expand keywords for queue
        async function expandQueueKeywords() {
            const query = document.getElementById('quickQuery').value;
            if (!query) {
                alert('Please enter a search query first');
                return;
            }

            // Parse query to extract keyword and location
            const parts = query.split(' in ');
            let keyword, location;
            if (parts.length === 2) {
                keyword = parts[0];
                location = parts[1];
            } else {
                const words = query.split(' ');
                if (words.length >= 2) {
                    keyword = words.slice(0, -1).join(' ');
                    location = words[words.length - 1];
                } else {
                    keyword = query;
                    location = '';
                }
            }

            try {
                const response = await fetch('/api/expand-keywords', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ keyword, location })
                });

                const data = await response.json();
                if (data.success) {
                    displayQueueKeywords(data.variants);
                }
            } catch (error) {
                console.error('Error expanding keywords:', error);
            }
        }

        // Display expanded keywords for queue
        function displayQueueKeywords(variants) {
            const container = document.getElementById('queueKeywordResults');
            container.innerHTML = `
                <div class="alert alert-info">
                    <h6>Select Keywords to Add to Queue:</h6>
                    <div class="row g-2" id="queueKeywordList"></div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" onclick="addSelectedToQueue()">
                            Add Selected to Queue
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="document.getElementById('queueKeywordResults').classList.add('d-none')">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            const list = document.getElementById('queueKeywordList');
            variants.forEach((variant, i) => {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input queue-keyword" type="checkbox" 
                               id="queueKw${i}" value="${variant.keyword}" checked>
                        <label class="form-check-label" for="queueKw${i}">
                            <strong>${variant.keyword}</strong>
                        </label>
                    </div>
                `;
                list.appendChild(col);
            });
            
            container.classList.remove('d-none');
        }

        // Add selected keywords to queue
        async function addSelectedToQueue() {
            const checkboxes = document.querySelectorAll('.queue-keyword:checked');
            const limit = document.getElementById('quickLimit').value;
            const verifyEmails = document.getElementById('queueVerifyEmails').checked;
            const generateEmails = document.getElementById('queueGenerateEmails').checked;
            const exportVerified = document.getElementById('queueExportVerified').checked;
            const advancedScraping = document.getElementById('queueAdvancedScraping').checked;
            const priority = document.getElementById('queuePriority').value;
            
            for (const checkbox of checkboxes) {
                await fetch('/api/queue', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: checkbox.value,
                        limit_leads: parseInt(limit),
                        priority: parseInt(priority),
                        verify_emails: verifyEmails,
                        generate_emails: generateEmails,
                        export_verified_only: exportVerified,
                        advanced_scraping: advancedScraping
                    })
                });
            }
            
            document.getElementById('queueKeywordResults').classList.add('d-none');
            loadQueue();
            alert(`Added ${checkboxes.length} searches to queue!`);
        }

        // Updated add to queue with all options
        async function addToQueueWithOptions() {
            const query = document.getElementById('quickQuery').value;
            const limit = document.getElementById('quickLimit').value;
            const verifyEmails = document.getElementById('queueVerifyEmails').checked;
            const generateEmails = document.getElementById('queueGenerateEmails').checked;
            const exportVerified = document.getElementById('queueExportVerified').checked;
            const advancedScraping = document.getElementById('queueAdvancedScraping').checked;
            const priority = document.getElementById('queuePriority').value;
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                const response = await fetch('/api/queue', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        limit_leads: parseInt(limit),
                        priority: parseInt(priority),
                        verify_emails: verifyEmails,
                        generate_emails: generateEmails,
                        export_verified_only: exportVerified,
                        advanced_scraping: advancedScraping
                    })
                });
                
                if (response.ok) {
                    document.getElementById('quickQuery').value = '';
                    loadQueue();
                    alert('Added to queue successfully!');
                }
            } catch (error) {
                console.error('Error adding to queue:', error);
                alert('Failed to add to queue');
            }
        }

        // Keep old function for backward compatibility
        async function addToQueue() {
            addToQueueWithOptions();
        }

        async function toggleSchedule(id, enabled) {
            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: enabled})
                });
                
                if (response.ok) {
                    loadSchedules();
                }
            } catch (error) {
                console.error('Error toggling schedule:', error);
            }
        }

        async function deleteSchedule(id) {
            if (!confirm('Are you sure you want to delete this schedule?')) return;
            
            try {
                const response = await fetch(`/api/schedules/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadSchedules();
                }
            } catch (error) {
                console.error('Error deleting schedule:', error);
            }
        }

        function showAddScheduleModal() {
            const modal = `
                <div class="modal fade" id="addScheduleModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Scheduled Search</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="scheduleForm">
                                    <div class="mb-3">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-control" id="scheduleName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Search Query</label>
                                        <input type="text" class="form-control" id="scheduleQuery" 
                                               placeholder="e.g., dentists in Miami" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Number of Leads</label>
                                        <input type="number" class="form-control" id="scheduleLimit" 
                                               value="25" min="5" max="1000">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Run Every (hours)</label>
                                        <select class="form-select" id="scheduleInterval">
                                            <option value="1">Every hour</option>
                                            <option value="6">Every 6 hours</option>
                                            <option value="12">Every 12 hours</option>
                                            <option value="24" selected>Daily</option>
                                            <option value="168">Weekly</option>
                                        </select>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="scheduleVerifyEmails" checked>
                                        <label class="form-check-label" for="scheduleVerifyEmails">
                                            <strong>Verify Emails</strong> - Check email validity and deliverability
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="scheduleGenerateEmails">
                                        <label class="form-check-label" for="scheduleGenerateEmails">
                                            <strong>Generate Emails</strong> - Create personalized outreach emails
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="scheduleExportVerifiedOnly" checked>
                                        <label class="form-check-label" for="scheduleExportVerifiedOnly">
                                            <strong>Export Only Verified Emails</strong> - Filter out invalid emails from CSV
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="scheduleAdvancedScraping">
                                        <label class="form-check-label" for="scheduleAdvancedScraping">
                                            <strong>Advanced Website Scraping</strong> - Extract contact names, job titles, team members
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="createSchedule()">Create Schedule</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page if not exists
            if (!document.getElementById('addScheduleModal')) {
                document.body.insertAdjacentHTML('beforeend', modal);
            }
            
            const modalEl = new bootstrap.Modal(document.getElementById('addScheduleModal'));
            modalEl.show();
        }

        async function createSchedule() {
            const name = document.getElementById('scheduleName').value;
            const query = document.getElementById('scheduleQuery').value;
            const limit = document.getElementById('scheduleLimit').value;
            const interval = document.getElementById('scheduleInterval').value;
            const verifyEmails = document.getElementById('scheduleVerifyEmails').checked;
            const generateEmails = document.getElementById('scheduleGenerateEmails').checked;
            const exportVerifiedOnly = document.getElementById('scheduleExportVerifiedOnly').checked;
            const advancedScraping = document.getElementById('scheduleAdvancedScraping').checked;
            
            if (!name || !query) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/schedules', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        query: query,
                        limit_leads: parseInt(limit),
                        interval_hours: parseInt(interval),
                        verify_emails: verifyEmails,
                        generate_emails: generateEmails,
                        export_verified_only: exportVerifiedOnly,
                        advanced_scraping: advancedScraping
                    })
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
                    loadSchedules();
                    alert('Schedule created successfully!');
                }
            } catch (error) {
                console.error('Error creating schedule:', error);
                alert('Failed to create schedule');
            }
        }

        // Load scheduler data when tab is shown
        document.getElementById('scheduler-tab').addEventListener('shown.bs.tab', function() {
            loadSchedules();
            loadQueue();
            loadHistory();
        });

        // Refresh scheduler data every 30 seconds when tab is active
        setInterval(() => {
            if (document.getElementById('scheduler').classList.contains('active')) {
                loadQueue();
                loadHistory();
            }
        }, 30000);

        // Enhanced Features Functions

        // Multi-Provider Search
        document.getElementById('multiProviderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const query = document.getElementById('multiQuery').value;
            const location = document.getElementById('multiLocation').value;
            const limit = document.getElementById('multiLimit').value;
            
            const providers = [];
            if (document.getElementById('providerGoogle').checked) providers.push('google_maps');
            if (document.getElementById('providerOSM').checked) providers.push('openstreetmap');
            if (document.getElementById('providerYP').checked) providers.push('yellowpages');
            
            if (providers.length === 0) {
                alert('Please select at least one data source');
                return;
            }
            
            try {
                const response = await fetch('/api/multi-provider-search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        location: location,
                        limit: parseInt(limit),
                        providers: providers
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayMultiProviderResults(data);
                } else {
                    alert('Search failed: ' + data.error);
                }
            } catch (error) {
                console.error('Multi-provider search error:', error);
                alert('Search failed');
            }
        });

        function displayMultiProviderResults(data) {
            const resultsDiv = document.getElementById('multiProviderResults');
            const summaryDiv = document.getElementById('multiProviderSummary');
            const dataDiv = document.getElementById('multiProviderData');
            
            // Display summary
            let summaryHtml = '<div class="row">';
            for (const [provider, result] of Object.entries(data.provider_breakdown)) {
                const status = result.error ? 'danger' : 'success';
                const count = result.count || 0;
                summaryHtml += `
                    <div class="col-md-4 mb-2">
                        <div class="alert alert-${status} mb-0 py-2">
                            <strong>${provider.replace('_', ' ').toUpperCase()}</strong><br>
                            ${result.error ? result.error : count + ' results'}
                        </div>
                    </div>
                `;
            }
            summaryHtml += '</div>';
            summaryDiv.innerHTML = summaryHtml;
            
            // Display first 10 results
            if (data.results && data.results.length > 0) {
                let dataHtml = `<p><strong>Total Unique Results: ${data.unique_results}</strong></p>`;
                dataHtml += '<div class="list-group" style="max-height: 400px; overflow-y: auto;">';
                
                data.results.slice(0, 10).forEach((result, index) => {
                    dataHtml += `
                        <div class="list-group-item">
                            <h6 class="fw-bold">${index + 1}. ${result.name || 'Unknown'}</h6>
                            <p class="mb-1 text-muted">${result.address || 'No address'}</p>
                            <small>
                                ${result.phone ? 'üìû ' + result.phone : ''} 
                                ${result.email ? 'üìß ' + result.email : ''}
                                ${result.website ? 'üåê Website' : ''}
                            </small>
                        </div>
                    `;
                });
                
                dataHtml += '</div>';
                if (data.results.length > 10) {
                    dataHtml += `<p class="mt-2 text-muted">Showing first 10 of ${data.results.length} results...</p>`;
                }
                dataDiv.innerHTML = dataHtml;
            }
            
            resultsDiv.classList.remove('d-none');
        }

        // Lead Enrichment
        document.getElementById('enrichmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('enrichmentFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            try {
                // Read CSV and parse it
                const text = await file.text();
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const leads = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const lead = {};
                        headers.forEach((header, index) => {
                            lead[header] = values[index] || '';
                        });
                        leads.push(lead);
                    }
                }
                
                const response = await fetch('/api/enrich-leads', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({leads: leads})
                });
                
                const data = await response.json();
                if (data.success) {
                    displayEnrichmentResults(data);
                } else {
                    alert('Enrichment failed: ' + data.error);
                }
            } catch (error) {
                console.error('Enrichment error:', error);
                alert('Enrichment failed');
            }
        });

        function displayEnrichmentResults(data) {
            const resultsDiv = document.getElementById('enrichmentResults');
            const summaryDiv = document.getElementById('enrichmentSummary');
            
            summaryDiv.innerHTML = `
                <h6>Enrichment Complete!</h6>
                <p>Successfully enriched ${data.total_processed} leads with additional data including social media profiles, company size estimates, and technology stack information.</p>
            `;
            
            // Store enriched data for download
            window.enrichedLeadsData = data.enriched_leads;
            
            resultsDiv.classList.remove('d-none');
        }

        // Download enriched leads
        document.getElementById('downloadEnrichedBtn').addEventListener('click', function() {
            if (!window.enrichedLeadsData) {
                alert('No enriched data available');
                return;
            }
            
            // Convert to CSV
            const headers = Object.keys(window.enrichedLeadsData[0]);
            let csv = headers.join(',') + '\n';
            
            window.enrichedLeadsData.forEach(lead => {
                const row = headers.map(header => {
                    const value = lead[header] || '';
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                });
                csv += row.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enriched_leads_${new Date().getTime()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Instantly Campaign Management
        document.getElementById('instantlyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const campaignName = document.getElementById('campaignName').value;
            const templateType = document.getElementById('templateType').value;
            const fileInput = document.getElementById('campaignLeadsFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a leads CSV file');
                return;
            }
            
            try {
                // Read and parse CSV
                const text = await file.text();
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const leads = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const lead = {};
                        headers.forEach((header, index) => {
                            lead[header] = values[index] || '';
                        });
                        leads.push(lead);
                    }
                }
                
                const response = await fetch('/api/instantly/create-campaign', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        leads: leads,
                        campaign_name: campaignName,
                        template_type: templateType
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayInstantlyResults(data);
                } else {
                    alert('Campaign creation failed: ' + data.error);
                }
            } catch (error) {
                console.error('Campaign creation error:', error);
                alert('Campaign creation failed');
            }
        });

        function displayInstantlyResults(data) {
            const resultsDiv = document.getElementById('instantlyResults');
            const messageDiv = document.getElementById('instantlyMessage');
            
            messageDiv.innerHTML = `
                <h6>Campaign Created Successfully!</h6>
                <p>Campaign "${data.campaign_created.campaign.name}" has been created with ${data.campaign_created.total_leads} leads.</p>
                <p><strong>Campaign ID:</strong> ${data.campaign_created.campaign.campaign_id}</p>
            `;
            
            resultsDiv.classList.remove('d-none');
            loadInstantlyCampaigns(); // Refresh campaigns list
        }

        async function loadInstantlyCampaigns() {
            try {
                const response = await fetch('/api/instantly/campaigns');
                const campaigns = await response.json();
                
                const listDiv = document.getElementById('campaignsList');
                if (campaigns.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted">No campaigns found. Create one above!</p>';
                } else {
                    let html = '<div class="list-group">';
                    campaigns.forEach(campaign => {
                        html += `
                            <div class="list-group-item">
                                <h6 class="fw-bold">${campaign.name}</h6>
                                <small class="text-muted">Status: ${campaign.status || 'Active'}</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                    listDiv.innerHTML = html;
                }
            } catch (error) {
                console.error('Failed to load campaigns:', error);
                document.getElementById('campaignsList').innerHTML = 
                    '<p class="text-danger">Failed to load campaigns. Check API configuration.</p>';
            }
        }

        // Provider Status Check
        async function checkProviderStatus() {
            try {
                const response = await fetch('/api/providers/available');
                const providers = await response.json();
                
                const statusDiv = document.getElementById('providerStatus');
                let html = '';
                
                for (const [key, provider] of Object.entries(providers)) {
                    const status = provider.configured ? 'success' : 'warning';
                    const icon = provider.configured ? '‚úÖ' : '‚ö†Ô∏è';
                    
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>${icon} ${provider.name}</h6>
                                    <p class="text-muted small">${provider.description}</p>
                                    <span class="badge bg-${status}">
                                        ${provider.configured ? 'Configured' : 'Not Configured'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                statusDiv.innerHTML = html;
            } catch (error) {
                console.error('Failed to check provider status:', error);
                document.getElementById('providerStatus').innerHTML = 
                    '<div class="col-12"><p class="text-danger">Failed to check provider status</p></div>';
            }
        }

        // Initialize tooltips for enhanced features
        document.getElementById('enhanced-tab').addEventListener('shown.bs.tab', function() {
            // Initialize Bootstrap tooltips
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
            
            // Auto-check provider status when tab is shown
            checkProviderStatus();
        });

        checkHealth();
    </script>
</body>
</html>